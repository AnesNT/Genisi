<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genisi | Server Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { --bg:#050505; --card:#121214; --border:#222; --blue:#3b82f6; --pink:#ec4899; }
        body { margin:0; background:var(--bg); color:#fff; font-family:'Space Grotesk',sans-serif; height:100vh; display:flex; flex-direction:column; overflow:hidden; }
        
        header { padding:15px 30px; display:flex; justify-content:space-between; background:#000; border-bottom:1px solid var(--border); }
        .logo { font-size:22px; font-weight:700; color:var(--blue); display:flex; gap:10px; }
        
        /* Switch */
        .sw { background:#111; border:1px solid var(--border); border-radius:30px; display:flex; position:relative; overflow:hidden; }
        .sw-btn { padding:6px 20px; font-size:12px; cursor:pointer; z-index:2; transition:0.3s; color:#666; font-weight:600; }
        .sw-btn.active { color:#fff; }
        .sw-bg { position:absolute; top:0; left:0; width:50%; height:100%; background:var(--blue); transition:0.3s; }
        
        body.pro .sw-bg { transform:translateX(100%); background:var(--pink); }
        body.pro .logo { color:var(--pink); }

        #chat { flex:1; padding:20px 15%; overflow-y:auto; scroll-behavior:smooth; }
        .row { display:flex; margin-bottom:20px; }
        .user { justify-content:flex-end; }
        .bot { justify-content:flex-start; }
        .bubble { padding:12px 20px; border-radius:18px; max-width:85%; line-height:1.6; }
        .u-b { background:#222; border:1px solid var(--border); }
        .b-b pre { background:#111; padding:15px; border-radius:8px; border:1px solid var(--border); overflow-x:auto; }
        .b-b code { font-family:'JetBrains Mono'; background:#222; padding:2px 5px; border-radius:4px; font-size:0.9em; }
        
        .gen-img { border-radius:12px; max-width:100%; border:1px solid var(--border); margin-top:10px; }

        .in-area { padding:20px 15%; background:#000; display:flex; gap:10px; align-items:center; }
        .in-box { flex:1; background:#111; border:1px solid var(--border); border-radius:50px; padding:10px 20px; display:flex; }
        input { flex:1; background:none; border:none; color:#fff; font-size:16px; outline:none; font-family:'Space Grotesk'; }
        button { width:45px; height:45px; border-radius:50%; border:none; background:#fff; cursor:pointer; display:flex; justify-content:center; align-items:center; transition:0.2s; }
        button:hover { transform:scale(1.1); }
        
        #welcome { text-align:center; margin-top:20vh; transition:0.3s; }
        .badge { font-size:11px; padding:4px 10px; border:1px solid #333; border-radius:10px; color:#555; }
    </style>
</head>
<body>

    <header>
        <div class="logo"><span class="material-symbols-rounded">dns</span> GENISI</div>
        <div class="sw" onclick="toggleMode()">
            <div class="sw-bg"></div>
            <div class="sw-btn active" id="b1">Genisi</div>
            <div class="sw-btn" id="b2">DeepSeek</div>
        </div>
    </header>

    <div id="chat">
        <div id="welcome">
            <h1 style="font-size:50px; margin:0">Grid Online.</h1>
            <p style="color:#666">Secure Server Connection • Python Backend</p>
            <span class="badge">Port 5000</span>
        </div>
    </div>

    <div class="in-area">
        <div class="in-box">
            <input type="text" id="txt" placeholder="Message Genisi Server..." autocomplete="off">
        </div>
        <button onclick="send()"><span class="material-symbols-rounded">arrow_upward</span></button>
    </div>

    <script>
        let isPro = false;
        const sessionId = "sess_" + Date.now();

        function toggleMode() {
            isPro = !isPro;
            document.body.classList.toggle('pro');
            document.getElementById('b1').classList.toggle('active');
            document.getElementById('b2').classList.toggle('active');
        }

        async function makeImage(prompt) {
             const clean = encodeURIComponent(prompt);
             const seed = Math.floor(Math.random()*100000);
             return `<div><small style="color:#777">❖ Flux Rendering...</small><br>
             <img src="https://image.pollinations.ai/prompt/${clean}?nologo=true&seed=${seed}&width=1024&height=1024&model=flux" class="gen-img" onload="this.scrollIntoView()"></div>`;
        }

        async function send() {
            const input = document.getElementById('txt');
            const val = input.value.trim();
            if(!val) return;

            document.getElementById('welcome').style.display = 'none';
            input.value = '';
            const box = document.getElementById('chat');

            // User
            box.innerHTML += `<div class="row user"><div class="bubble u-b">${val.replace(/</g, "&lt;")}</div></div>`;
            box.scrollTop = box.scrollHeight;

            // Loading
            const id = "L"+Date.now();
            box.innerHTML += `<div class="row bot" id="${id}"><div class="bubble b-b" style="color:#666">Processing...</div></div>`;
            box.scrollTop = box.scrollHeight;

            try {
                // الاتصال بالسيرفر المحلي (Python Flask)
                // لاحظ: لا توجد مفاتيح هنا! كله في الباك اند
                const res = await fetch('http://localhost:5000/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        text: val,
                        mode: isPro ? 'pro' : 'std',
                        session: sessionId
                    })
                });

                if(!res.ok) throw new Error("Server connection failed. Is python running?");

                const data = await res.json();
                let output = "";

                if (data.type === "image") {
                    output = await makeImage(val);
                } else if (data.type === "error") {
                    output = `<span style="color:red">${data.reply}</span>`;
                } else {
                    // النص القادم من السيرفر
                    output = marked.parse(data.reply);
                }

                document.getElementById(id).innerHTML = `<div class="bubble b-b">${output}</div>`;

            } catch(e) {
                document.getElementById(id).innerHTML = `<div class="bubble b-b" style="color:red">Error: ${e.message}<br><small>تأكد من تشغيل server.py</small></div>`;
            }
            box.scrollTop = box.scrollHeight;
        }

        document.getElementById('txt').addEventListener('keypress', e => e.key==='Enter' && send());
    </script>
</body>
</html>